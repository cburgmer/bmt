<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BMT thermal + visual report</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #1a1a1a;
      color: #e0e0e0;
      min-height: 100vh;
    }
    h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 1rem 0;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .mode-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #444;
      border-radius: 6px;
      background: #2a2a2a;
      color: #e0e0e0;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .mode-btn:hover {
      background: #333;
    }
    .mode-btn.active {
      background: #0d6efd;
      border-color: #0d6efd;
      color: #fff;
    }
    .overlay-controls {
      display: none;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    body[data-mode="overlay"] .overlay-controls {
      display: flex;
    }
    .overlay-controls label {
      font-size: 0.9rem;
      color: #999;
    }
    .overlay-controls input[type="range"] {
      width: 120px;
      accent-color: #0d6efd;
    }
    #content {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    .record {
      width: 100%;
    }
    .record h2 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 0.75rem 0;
      color: #ccc;
    }
    .sidebyside-view {
      display: none;
      gap: 1rem;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
      width: 100%;
    }
    body[data-mode="sidebyside"] .sidebyside-view {
      display: flex;
    }
    .sidebyside-view .img-wrap {
      flex: 0 0 auto;
      text-align: center;
    }
    .sidebyside-view .img-wrap img {
      display: block;
      height: 480px;
      width: auto;
      max-width: 100%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
    }
    .sidebyside-view .img-wrap span {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #999;
    }
    .overlay-view {
      display: none;
      width: 100%;
    }
    body[data-mode="overlay"] .overlay-view {
      display: block;
    }
    .overlay-wrap {
      position: relative;
      display: inline-block;
      max-width: 100%;
      line-height: 0;
    }
    .overlay-wrap .base {
      display: block;
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
    }
    .overlay-wrap .thermal-layer {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
      border-radius: 8px;
      transition: opacity 0.15s ease;
    }
    .error {
      color: #f66;
      padding: 1rem;
    }
    .loading {
      color: #999;
      padding: 1rem;
    }
  </style>
</head>
<body data-mode="sidebyside">
  <h1 id="title">Thermal + visual</h1>
  <div class="toolbar">
    <button type="button" class="mode-btn active" data-mode="sidebyside">Side by side</button>
    <button type="button" class="mode-btn" data-mode="overlay">Thermal over visual (alpha)</button>
  </div>
  <div class="overlay-controls">
    <label for="alpha">Thermal opacity (all):</label>
    <input type="range" id="alpha" min="0" max="100" value="60" />
    <span id="alpha-value">60%</span>
  </div>
  <div id="error" class="error" style="display: none;"></div>
  <div id="loading" class="loading" style="display: none;">Loading…</div>
  <div id="content"></div>

  <script>
    (function () {
      const STEMS_INLINE = /* __STEMS_JSON__ */ null;

      const params = new URLSearchParams(location.search || '');
      const pathMatch = (window.location.pathname || '').match(/([^/]+)_report\.html$/);
      const stemFromUrl = params.get('stem') || (pathMatch ? pathMatch[1] : null) || 'IV_01279';

      const errorEl = document.getElementById('error');
      const loadingEl = document.getElementById('loading');
      const contentEl = document.getElementById('content');
      const titleEl = document.getElementById('title');

      function showError(msg) {
        loadingEl.style.display = 'none';
        contentEl.innerHTML = '';
        errorEl.style.display = 'block';
        errorEl.textContent = msg;
      }

      function getStems() {
        if (Array.isArray(STEMS_INLINE) && STEMS_INLINE.length > 0) {
          return Promise.resolve(STEMS_INLINE);
        }
        return fetch('stems.json')
          .then(function (r) { return r.ok ? r.json() : Promise.reject(); })
          .then(function (arr) { return Array.isArray(arr) ? arr : [stemFromUrl]; })
          .catch(function () { return [stemFromUrl]; });
      }

      function buildSection(stem) {
        const thermalUrl = stem + '_thermal_320x240.bmp';
        const visualUrl = stem + '_visual_640x480.bmp';

        const section = document.createElement('section');
        section.className = 'record';
        section.innerHTML =
          '<h2>' + stem + '</h2>' +
          '<div class="sidebyside-view">' +
            '<div class="img-wrap"><img class="sb-thermal" alt="Thermal" /><span>Thermal (320×240)</span></div>' +
            '<div class="img-wrap"><img class="sb-visual" alt="Visual" /><span>Visual (640×480)</span></div>' +
          '</div>' +
          '<div class="overlay-view">' +
            '<div class="overlay-wrap">' +
              '<img class="base ov-visual" alt="Visual" />' +
              '<img class="thermal-layer ov-thermal" alt="Thermal overlay" />' +
            '</div>' +
          '</div>';

        const sbThermal = section.querySelector('.sb-thermal');
        const sbVisual = section.querySelector('.sb-visual');
        const ovVisual = section.querySelector('.ov-visual');
        const ovThermal = section.querySelector('.ov-thermal');

        sbThermal.src = ovThermal.src = thermalUrl;
        sbVisual.src = ovVisual.src = visualUrl;

        return { section: section, ovThermal: ovThermal };
      }

      function switchMode(mode) {
        document.body.setAttribute('data-mode', mode);
        document.querySelectorAll('.mode-btn').forEach(function (btn) {
          btn.classList.toggle('active', btn.getAttribute('data-mode') === mode);
        });
      }

      getStems().then(function (stems) {
        stems = stems.slice().sort();
        titleEl.textContent = stems.length > 1
          ? 'BMT report — ' + stems.length + ' pictures'
          : 'BMT: ' + stems[0] + ' — Thermal + visual';

        const thermalLayers = [];
        stems.forEach(function (stem) {
          const { section, ovThermal } = buildSection(stem);
          contentEl.appendChild(section);
          thermalLayers.push(ovThermal);
        });

        const loadPromises = stems.map(function (stem) {
          const thermalUrl = stem + '_thermal_320x240.bmp';
          const visualUrl = stem + '_visual_640x480.bmp';
          return Promise.all([
            new Promise(function (resolve, reject) {
              const img = new Image();
              img.onload = resolve;
              img.onerror = function () { reject(new Error('Failed to load ' + thermalUrl)); };
              img.src = thermalUrl;
            }),
            new Promise(function (resolve, reject) {
              const img = new Image();
              img.onload = resolve;
              img.onerror = function () { reject(new Error('Failed to load ' + visualUrl)); };
              img.src = visualUrl;
            })
          ]);
        });

        Promise.all(loadPromises).then(function () {
          loadingEl.style.display = 'none';
          errorEl.style.display = 'none';
          switchMode('sidebyside');
        }).catch(function (err) {
          showError(err.message + ' — Open the report from the folder that contains the extracted BMPs (and optionally stems.json).');
        });

        document.querySelectorAll('.mode-btn').forEach(function (btn) {
          btn.addEventListener('click', function () {
            switchMode(btn.getAttribute('data-mode'));
          });
        });

        const alphaSlider = document.getElementById('alpha');
        const alphaValue = document.getElementById('alpha-value');
        function setOverlayOpacity(pct) {
          thermalLayers.forEach(function (el) { el.style.opacity = pct / 100; });
          alphaValue.textContent = pct + '%';
        }
        alphaSlider.addEventListener('input', function () {
          setOverlayOpacity(parseInt(alphaSlider.value, 10));
        });
        setOverlayOpacity(parseInt(alphaSlider.value, 10));
      }).catch(function (err) {
        showError(err.message);
      });
    })();
  </script>
</body>
</html>
